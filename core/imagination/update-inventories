#!/bin/bash
set -eu
cd "$(dirname $BASH_SOURCE)"
source ../.magritte/util/docker.sh

echo 'Updating inventories...'
for d in */; do
  env="$(basename "$d")"
  pushd "$env" >/dev/null
  echo '###############################################################################' > inventory
  echo '#                                                                             #' >> inventory
  echo '# DO NOT EDIT THIS FILE!                                                      #' >> inventory
  echo '#                                                                             #' >> inventory
  echo '# Make your changes to:                                                       #' >> inventory
  echo '#                                                                             #' >> inventory
  echo "#     imagination/<environment>/inventory.template                            #" >> inventory
  echo '#                                                                             #' >> inventory
  echo '# Then run:                                                                   #' >> inventory
  echo '#                                                                             #' >> inventory
  echo '#     imagination/update-inventories                                          #' >> inventory
  echo '#                                                                             #' >> inventory
  echo '###############################################################################' >> inventory
  echo >> inventory
  for name in $(find ../../docker -mindepth 1 -type d -exec basename '{}' \;); do
    if container_running "$name" && grep "$name" inventory.template >/dev/null; then
      echo "$name ansible_host=$(docker inspect -f "{{ .NetworkSettings.IPAddress }}" $name) ansible_ssh_extra_args=\"-o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no\"" >> inventory
    fi
  done
  echo >> inventory
  cat inventory.template >> inventory
  popd >/dev/null
done
